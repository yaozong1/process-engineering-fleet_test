# å……ç”µæ¡©ï¼ˆCharge Nodeï¼‰MQTT Payload æ ¼å¼è¯´æ˜

## 1. MQTTä¸»é¢˜æ ¼å¼
```
fleet/chargenode/{stationId}
```
ç¤ºä¾‹ï¼š`fleet/chargenode/PN-001`ï¼Œ`fleet/chargenode/PN-002`

---

## 2. æ•°æ®å­˜å‚¨æ¶æ„ï¼ˆç®€åŒ–ç‰ˆ v2.0ï¼‰

### Rediså­˜å‚¨ç»“æ„
å……ç”µæ¡©æ•°æ®ç°åœ¨ä½¿ç”¨ä¸battery/GPSç›¸åŒçš„å•ä¸€é”®å­˜å‚¨æ–¹å¼ï¼š

```
Redisé”®: telemetry:chargenode:{stationId}
å­˜å‚¨ç±»å‹: Listï¼ˆRedis Listï¼‰
æ•°æ®æ ¼å¼: JSONå­—ç¬¦ä¸²
å†å²è®°å½•: æœ€å¤šä¿ç•™200æ¡è®°å½•
è¿‡æœŸæ—¶é—´: 24å°æ—¶
```

**ç¤ºä¾‹Redisé”®ï¼š**
- `telemetry:chargenode:PN-001`
- `telemetry:chargenode:PN-002`

### ç¦»çº¿æ£€æµ‹æœºåˆ¶
å……ç”µæ¡©è®¾å¤‡ç¦»çº¿æ£€æµ‹é‡‡ç”¨åŸºäºæ—¶é—´æˆ³çš„è¶…æ—¶æœºåˆ¶ï¼š

```
è¶…æ—¶é˜ˆå€¼: 5åˆ†é’Ÿ (300ç§’)
æ£€æµ‹é€»è¾‘: å½“å‰æ—¶é—´ - æœ€åæ•°æ®æ—¶é—´æˆ³ > 300000æ¯«ç§’
è‡ªåŠ¨å¤„ç†: è¶…æ—¶çš„å……ç”µæ¡©è‡ªåŠ¨æ ‡è®°ä¸º "offline" çŠ¶æ€
æ£€æµ‹é¢‘ç‡: æ¯æ¬¡APIè°ƒç”¨æ—¶å®æ—¶æ£€æµ‹
```

**ç¦»çº¿æ£€æµ‹æµç¨‹ï¼š**
1. APIè·å–å……ç”µæ¡©æœ€æ–°æ•°æ®æ—¶æ£€æŸ¥æ—¶é—´æˆ³
2. è®¡ç®—ä¸å½“å‰æ—¶é—´çš„å·®å€¼
3. è¶…è¿‡5åˆ†é’Ÿåˆ™å¼ºåˆ¶è®¾ç½®çŠ¶æ€ä¸º "offline"
4. å‰ç«¯æ˜¾ç¤ºè¶…æ—¶è­¦å‘Šæç¤º

### å­˜å‚¨ä¼˜åŠ¿
1. **ç®€åŒ–æ¶æ„**ï¼šä»3ä¸ªRedisé”®ç®€åŒ–ä¸º1ä¸ªé”®
2. **ä¸€è‡´æ€§**ï¼šä¸battery/GPSæ•°æ®å­˜å‚¨æ–¹å¼å®Œå…¨ä¸€è‡´
3. **ç»´æŠ¤æ€§**ï¼šæ›´å®¹æ˜“ç®¡ç†å’Œè°ƒè¯•
4. **æ€§èƒ½**ï¼šå‡å°‘Redisæ“ä½œæ¬¡æ•°
5. **ç¦»çº¿æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹è®¾å¤‡ç¦»çº¿çŠ¶æ€

---

## 3. Payload æ•°æ®ç»“æ„

```jsonc
{
  "ts": 1695456789123,                // æ—¶é—´æˆ³ (Unixæ¯«ç§’)
  "status": "charging",                // çŠ¶æ€
  "voltage": 415.2,                     // ç”µå‹ (V)
  "current": 125.8,                     // ç”µæµ (A)
  "power": 52.2,                        // åŠŸç‡ (kW)
  "energy": 28.5,                       // å·²å……ç”µèƒ½é‡ (kWh)
  "remainingTime": 45,                  // å‰©ä½™æ—¶é—´ (åˆ†é’Ÿ)
  "temperature": 35.4,                  // æ¸©åº¦ (Â°C)
  "connectorType": "CCS2",             // è¿æ¥å™¨ç±»å‹
  "maxPower": 150,                      // æœ€å¤§åŠŸç‡ (kW)
  "location": "åœè½¦ä½ 001",             // ç‰©ç†ä½ç½®
  "faultCode": null,                    // æ•…éšœä»£ç 
  "faultMessage": null                  // æ•…éšœæè¿°
}
```

---

## 4. å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µ            | ç±»å‹           | å¿…éœ€ | è¯´æ˜             | ç¤ºä¾‹å€¼         |
|-----------------|----------------|------|------------------|----------------|
| ts              | number         | âœ…   | Unixæ—¶é—´æˆ³(æ¯«ç§’) | 1695456789123  |
| status          | string         | âœ…   | å……ç”µæ¡©çŠ¶æ€       | "charging"    |
| voltage         | number/null    | âŒ   | è¾“å‡ºç”µå‹(V)      | 415.2          |
| current         | number/null    | âŒ   | è¾“å‡ºç”µæµ(A)      | 125.8          |
| power           | number/null    | âŒ   | å½“å‰åŠŸç‡(kW)     | 52.2           |
| energy          | number/null    | âŒ   | å·²å……èƒ½é‡(kWh)    | 28.5           |
| remainingTime   | number/null    | âŒ   | å‰©ä½™æ—¶é—´(åˆ†é’Ÿ)   | 45             |
| maxPower        | number         | âœ…   | æœ€å¤§åŠŸç‡(kW)     | 150            |
| connectorType   | string         | âœ…   | è¿æ¥å™¨ç±»å‹       | "CCS2"        |
| temperature     | number         | âœ…   | è®¾å¤‡æ¸©åº¦(Â°C)     | 35.4           |
| location        | string         | âœ…   | ç‰©ç†ä½ç½®         | "åœè½¦ä½ 001"  |
| faultCode       | string/null    | âŒ   | æ•…éšœä»£ç          | "E001"        |
| faultMessage    | string/null    | âŒ   | æ•…éšœæè¿°         | "æ¸©åº¦è¿‡é«˜"    |

---

## 4. çŠ¶æ€è¯´æ˜

| çŠ¶æ€        | è¯´æ˜           | ç”µå‹/ç”µæµ/åŠŸç‡ | å…¶ä»–ç‰¹å¾                | è§¦å‘æ¡ä»¶ |
|-------------|----------------|----------------|-------------------------|----------|
| "idle"      | ç©ºé—²å¾…æœº       | æœ‰ç”µå‹ï¼Œæ— ç”µæµ | power = 0               | è®¾å¤‡æ­£å¸¸é€šä¿¡ï¼Œæ— å……ç”µæ´»åŠ¨ |
| "charging"  | æ­£åœ¨å……ç”µ       | æ­£å¸¸å·¥ä½œå‚æ•°   | æœ‰åŠŸç‡è¾“å‡º              | è®¾å¤‡æ­£å¸¸é€šä¿¡ï¼Œæ­£åœ¨å……ç”µ |
| "fault"     | è®¾å¤‡æ•…éšœ       | å¯èƒ½å¼‚å¸¸æˆ–ä¸ºç©º | åŒ…å«æ•…éšœä¿¡æ¯            | è®¾å¤‡ä¸ŠæŠ¥æ•…éšœçŠ¶æ€ |
| "offline"   | ç¦»çº¿æ–­ç½‘       | é€šå¸¸ä¸ºç©º       | è®¾å¤‡æ— å“åº”              | **è¶…è¿‡5åˆ†é’Ÿæ— æ•°æ®ä¸Šä¼ ** |
| "occupied"  | è¢«å ç”¨æœªå……ç”µ   | å¯èƒ½æœ‰ç”µå‹æ— ç”µæµ | è½¦è¾†å·²è¿æ¥ä½†æœªå¼€å§‹å……ç”µ | è®¾å¤‡æ£€æµ‹åˆ°è½¦è¾†è¿æ¥ |

### ç¦»çº¿æ£€æµ‹è¯¦æƒ…
- **è¶…æ—¶æ—¶é—´**ï¼š5åˆ†é’Ÿ (300ç§’)
- **æ£€æµ‹æ–¹å¼**ï¼šåŸºäºæœ€åæ•°æ®æ—¶é—´æˆ³
- **è‡ªåŠ¨å¤„ç†**ï¼šAPIè‡ªåŠ¨å°†è¶…æ—¶è®¾å¤‡æ ‡è®°ä¸º "offline"
- **å‰ç«¯æç¤º**ï¼šæ˜¾ç¤º "âš ï¸ è®¾å¤‡è¶…æ—¶ç¦»çº¿ (è¶…è¿‡5åˆ†é’Ÿæ— æ•°æ®)" è­¦å‘Š

---

## 5. Payload ç¤ºä¾‹

### 5.1 æ­£åœ¨å……ç”µ
```json
{
  "ts": 1695456789123,
  "status": "charging",
  "voltage": 415.2,
  "current": 125.8,
  "power": 52.2,
  "energy": 28.5,
  "remainingTime": 45,
  "temperature": 35.4,
  "connectorType": "CCS2",
  "maxPower": 150,
  "location": "åœè½¦ä½ 001",
  "faultCode": null,
  "faultMessage": null
}
```

### 5.2 ç©ºé—²å¾…æœº
```json
{
  "ts": 1695456789123,
  "status": "idle",
  "voltage": 380.5,
  "current": 0,
  "power": 0,
  "energy": null,
  "remainingTime": null,
  "temperature": 25.2,
  "connectorType": "CCS2",
  "maxPower": 150,
  "location": "åœè½¦ä½ 002",
  "faultCode": null,
  "faultMessage": null
}
```

### 5.3 è®¾å¤‡æ•…éšœ
```json
{
  "ts": 1695456789123,
  "status": "fault",
  "voltage": null,
  "current": 0,
  "power": 0,
  "energy": null,
  "remainingTime": null,
  "temperature": 75.8,
  "connectorType": "CHAdeMO",
  "maxPower": 150,
  "location": "åœè½¦ä½ 003",
  "faultCode": "E001",
  "faultMessage": "æ¸©åº¦è¿‡é«˜"
}
```

### 5.4 è¢«å ç”¨æœªå……ç”µ
```json
{
  "ts": 1695456789123,
  "status": "occupied",
  "voltage": 385.0,
  "current": 0,
  "power": 0,
  "energy": null,
  "remainingTime": null,
  "temperature": 28.1,
  "connectorType": "Type2",
  "maxPower": 150,
  "location": "åœè½¦ä½ 004",
  "faultCode": null,
  "faultMessage": null
}
```

---

## 6. è¿æ¥å™¨ç±»å‹ (connectorType)
- "CCS2" - Combined Charging System 2
- "CHAdeMO" - æ—¥æœ¬å¿«å……æ ‡å‡†
- "Type2" - æ¬§æ´²äº¤æµå……ç”µæ ‡å‡†
- "GB/T" - ä¸­å›½å›½æ ‡

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **å……ç”µæ¡©æ˜¾ç¤ºè¶…æ—¶ç¦»çº¿**
   - æ£€æŸ¥MQTTæ¶ˆæ¯çš„æ—¶é—´æˆ³ `ts` å­—æ®µæ˜¯å¦ä¸ºå½“å‰æ—¶é—´
   - ä½¿ç”¨ `Date.now()` ç”Ÿæˆæ­£ç¡®çš„æ—¶é—´æˆ³
   - è¶…è¿‡5åˆ†é’Ÿçš„æ—§æ—¶é—´æˆ³ä¼šè¢«æ ‡è®°ä¸ºè¶…æ—¶

2. **MQTTæ¶ˆæ¯æ ¼å¼é”™è¯¯**
   - ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½åŒ…å«åœ¨æ¶ˆæ¯ä¸­
   - æ£€æŸ¥æ•°æ®ç±»å‹æ˜¯å¦æ­£ç¡®ï¼ˆæ•°å­—ç±»å‹ä¸è¦ç”¨å­—ç¬¦ä¸²ï¼‰

3. **è®¾å¤‡åˆ—è¡¨æ±¡æŸ“é—®é¢˜** â­ **å·²ä¿®å¤**
   - **é—®é¢˜**: Batteryå’ŒGPSé¡µé¢ä¼šè°ƒç”¨å……ç”µæ¡©API (`GET /api/telemetry?device=chargenode:PN-001&latest=1`)
   - **åŸå› **: `/api/telemetry?list=1` è¿”å›æ‰€æœ‰è®¾å¤‡ï¼ŒåŒ…æ‹¬å……ç”µæ¡©
   - **è§£å†³**: å·²ä¿®å¤è®¾å¤‡åˆ—è¡¨APIï¼Œç°åœ¨åªè¿”å›è½¦è¾†è®¾å¤‡ (PE-xxx)ï¼Œæ’é™¤å……ç”µæ¡©è®¾å¤‡ (chargenode:xxx)
   - **éªŒè¯**: `curl "http://localhost:3000/api/telemetry?list=1"` åº”è¯¥åªè¿”å› PE-xxx è®¾å¤‡
   - **æ•ˆæœ**: åˆ‡æ¢åˆ°Battery/GPSé¡µé¢æ—¶ä¸å†æ‰§è¡Œå……ç”µæ¡©APIè°ƒç”¨

## 7. åŠŸç‡è®¡ç®—
```
power (kW) = voltage (V) Ã— current (A) Ã· 1000
```

---

æœ¬è¯´æ˜é€‚ç”¨äºæ‰€æœ‰ `fleet/chargenode/{stationId}` ä¸»é¢˜çš„å……ç”µæ¡©MQTTæ•°æ®ã€‚